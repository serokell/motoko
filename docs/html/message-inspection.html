<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>md/message-inspection.md</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">md/message-inspection.md</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#message-inspection" id="toc-message-inspection">Message
inspection</a>
<ul>
<li><a href="#example" id="toc-example">Example</a></li>
<li><a href="#tips-on-authoring-inspect"
id="toc-tips-on-authoring-inspect">Tips on authoring
<code>inspect</code></a></li>
</ul></li>
</ul>
</nav>
<h1 id="message-inspection">Message inspection</h1>
<p>On the Internet Computer, a canister can selectively <em>inspect</em>
and <em>accept</em> or <em>decline</em> ingress messages submitted
through the HTTP interface:</p>
<blockquote>
<p>A canister can inspect ingress messages before executing them. When
the IC receives an update call from a user, the IC will use the canister
method <code>canister_inspect_message</code> to determine whether the
message shall be accepted. If the canister is empty (i.e. does not have
a Wasm module), then the ingress message will be rejected. If the
canister is not empty and does not implement
<code>canister_inspect_message</code>, then the ingress message will be
accepted.</p>
<p>In <code>canister_inspect_message</code>, the canister can accept the
message by invoking <code>ic0.accept_message : () → ()</code>. This
function traps if invoked twice. If the canister traps in
<code>canister_inspect_message</code> or does not call
<code>ic0.accept_message</code>, then the access is denied.</p>
<p>The <code>canister_inspect_message</code> is <em>not</em> invoked for
HTTP query calls, inter-canister calls or calls to the management
canister.</p>
<p>— <a
href="https://smartcontracts.org/docs/current/references/ic-interface-spec/#ingress-message-inspection">IC
Interface Specification</a></p>
</blockquote>
<p>Message inspection mitigates some denial of service attacks, designed
to drain canisters of cycles by placing unsolicited free calls.</p>
<p>:::note</p>
<p>You can think of method inspection as providing the "Collect call
from <em>name</em>. Do you accept charges?" prologue of an
old-fashioned, operator-assisted, collect phone call.</p>
<p>:::</p>
<p>In Motoko, actors can elect to inspect and accept or decline ingress
messages by declaring a particular <code>system</code> function called
<code>inspect</code>. Given a record of message attributes, this
function produces a <code>Bool</code> that indicates whether to accept
or decline the message by returning <code>true</code> or
<code>false</code>. The function is invoked (by the system) on each
ingress message. Similar to a query, any side-effects of an invocation
are discarded and transient. A call that traps due to some fault has the
same result as returning <code>false</code> (message declination).</p>
<p>Unlike other system functions, that have a fixed argument type, the
argument type of <code>inspect</code> depends on the interface of the
enclosing actor. In particular, the formal argument of
<code>inspect</code> is a record of fields of the following types:</p>
<ul>
<li><p><code>caller : Principal</code>: the principal, possibly
anonymous, of the caller of the message;</p></li>
<li><p><code>arg : Blob</code>: the raw, binary content of the message
argument;</p></li>
<li><p><code>msg : &lt;variant&gt;</code>: a variant of
<em>decoding</em> functions, where
<code>&lt;variant&gt; == {…​; #&lt;id&gt;: () → T; …​}</code> contains one
variant per shared function, <code>&lt;id&gt;</code>, of the actor. The
variant’s tag identifies the function to be called; The variant’s
argument is a function that, when applied, returns the (decoded)
argument of the call as a value of type <code>T</code>.</p></li>
</ul>
<p>Using a variant, tagged with <code>#&lt;id&gt;</code>, allows the
return type, <code>T</code>, of the decoding function to vary with the
argument type (also <code>T</code>) of the shared function
<code>&lt;id&gt;</code>.</p>
<p>The variant’s argument is a function so that one can avoid the
expense of message decoding (when appropriate).</p>
<p>Exploiting subtyping, the formal argument can omit record fields it
does not require, or selectively ignore the arguments of particular
shared functions, for example, in order to simply dispatch on the name
of a function without inspecting its actual argument.</p>
<p>:::note</p>
<p>Confusingly, a <code>shared query</code> function <em>can</em> be
called using a regular HTTP update call to obtain a certified response:
this is why the variant type also includes <code>shared query</code>
functions. A <code>shared composite query</code> function, on the other
hand, <em>cannot</em> be called as an update call, and only with the
faster, but uncertified, HTTP query call. This is why the
<code>inspect</code> variant type includes <code>shared query</code>
functions, but not <code>shared composite query</code> functions.</p>
<p>:::</p>
<p>:::danger</p>
<p>An actor that fails to declare system field <code>inspect</code> will
simply accept all ingress messages.</p>
<p>:::</p>
<p>:::danger</p>
<p>System function <code>inspect</code> should <strong>not</strong> be
used for definitive access control. This is because <code>inspect</code>
is executed by a single replica, without full consensus, and its result
could be spoofed by a malicious boundary node. Reliable access control
checks can only be performed within the <code>shared</code> functions
guarded by <code>inspect</code>.</p>
<p>:::</p>
<h2 id="example">Example</h2>
<p>A simple, contrived example of method inspection is a counter actor,
that inspects some of its messages in detail, and others only
superficially:</p>
<pre class="motoko"><code></code></pre>
<p>Note that, due to subtyping, all of the following variations, in
order of increasing argument specificity, are legal definitions of
<code>inspect</code>.</p>
<p>Blanket denial of all ingress messages, ignoring further
information:</p>
<pre class="motoko"><code></code></pre>
<p>Declining anonymous calls:</p>
<pre class="motoko"><code></code></pre>
<p>Declining large messages, based on the raw size (in bytes) of
<code>arg</code> (prior to any decoding from Candid binary blob to
Motoko value):</p>
<pre class="motoko"><code></code></pre>
<p>Declining messages by name only, ignoring message arguments (note the
use of type <code>Any</code> as message argument variants):</p>
<pre class="motoko"><code></code></pre>
<p>A combination of the previous three, specifying the argument types of
some variants while ignoring others at type <code>Any</code> and using
pattern matching to conflate identical cases.</p>
<pre class="motoko"><code></code></pre>
<h2 id="tips-on-authoring-inspect">Tips on authoring
<code>inspect</code></h2>
<p>Implementing <code>inspect</code> after the fact, once all shared
functions of an actor have already been implemented, can be tedious,
since you’ll need to declare a correctly typed variant for each shared
function. A simple trick is to first implement the function
<em>incorrectly</em>, with a <code>()</code> argument, compile the code,
then use the compiler’s error message to obtain the required argument
type.</p>
<p>For example, in the actor from the previous section, incorrectly
declaring:</p>
<pre class="motoko"><code></code></pre>
<p>forces the compiler to report the expected type below:</p>
<pre class="motoko"><code>Inspect.mo:12.4-14.5: type error [M0127], system function inspect is declared with type
  () -&gt; Bool
instead of expected type
  {
    arg : Blob;
    caller : Principal;
    msg :
      {
        #inc : () -&gt; ();
        #read : () -&gt; ();
        #reset : () -&gt; ();
        #set : () -&gt; Nat
      }
  } -&gt; Bool</code></pre>
<p>which you can now cut-and-paste into your code.</p>
</body>
</html>
