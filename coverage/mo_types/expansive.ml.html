<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>expansive.ml &mdash; Coverage report</title>
    <meta name="description" content="80.49% coverage in mo_types/expansive.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">mo_types/</span>expansive.ml
        </a>
      </h1>
      <h2>80.49%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:34.60%"></span>
      <span class="unvisited" style="top:36.02%"></span>
      <span class="unvisited" style="top:37.44%"></span>
      <span class="unvisited" style="top:38.86%"></span>
      <span class="some-visited" style="top:45.50%"></span>
      <span class="unvisited" style="bottom:22.75%"></span>
      <span class="unvisited" style="bottom:22.27%"></span>
      <span class="some-visited" style="bottom:6.64%"></span>
      <span class="some-visited" style="bottom:5.69%"></span>
      <span class="unvisited" style="bottom:1.42%"></span>
      <span class="unvisited" style="bottom:0.47%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span class="visited"> </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span > </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="unvisited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="unvisited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="unvisited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="unvisited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span class="visited"> </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span class="visited"> </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span class="visited"> </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span class="some-visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span class="visited"> </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span class="visited"> </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span class="visited"> </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span class="visited"> </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span class="visited"> </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span class="visited"> </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span class="unvisited"> </span>
<a id="L164"></a><span class="unvisited"> </span>
<a id="L165"></a><span > </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span class="visited"> </span>
<a id="L174"></a><span class="visited"> </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span > </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span > </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span > </span>
<a id="L186"></a><span class="visited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span class="visited"> </span>
<a id="L189"></a><span class="visited"> </span>
<a id="L190"></a><span > </span>
<a id="L191"></a><span class="visited"> </span>
<a id="L192"></a><span class="visited"> </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span > </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span class="visited"> </span>
<a id="L197"></a><span class="some-visited"> </span>
<a id="L198"></a><span class="visited"> </span>
<a id="L199"></a><span class="some-visited"> </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span > </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span > </span>
<a id="L206"></a><span > </span>
<a id="L207"></a><span > </span>
<a id="L208"></a><span class="unvisited"> </span>
<a id="L209"></a><span > </span>
<a id="L210"></a><span class="unvisited"> </span>
<a id="L211"></a><span class="visited"> </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
</pre>
<pre><code class="ocaml">open Type

(*

  Check the non-expansiveness criterion identified first by Viroli and
  adopted by Pierce and Kennedy [1] to ensure termination of sub-typing
  in *nominal* type systems with generics and subtyping.

  Given a set of mutually recursive type definitions, construct a graph
  whose vertices are the formal parameters (identified by position),
  `C#i`, and two sorts of labeled edges:

  * an occurrence of parameter `C#i` as immediate `j`-th argument to
    type `D&lt;..,C#i,..&gt;`, adds a (non-expansive) 0-labeled edge `C#i -0-&gt;D#j`.

  * an occurrence of parameter `C#i` as a proper sub-term of the `j`-th
    argument to type `D&lt;...,T[C#i],..&gt;` adds an (expansive) 1-labeled
    edge `C#i -1-&gt; D#j`.

  The graph is expansive iff it contains a cycle with at least one
  expansive edge.

  Non-expansiveness (hopefully) ensures that the set of types
  encountered during sub-typing, and added to the visited set, is
  finite. In nominal systems, a visited set is used to reject a
  cyclic sub-type check, but in our co-inductive setting, it is used
  to succeed a cyclic check. In either case, it is used to terminate the
  procedure, which is what we care about.

  To detect the existence of a cycle, we construct the plain graph
  obtained by deleting labels (possibly identifying edges), compute
  its strongly connected components (sccs), and then check whether
  there is a 1-weighted edge (in the original graph) connecting any
  two vertices of the *same* component of the sccs.

  [1] Andrew Kennedy Benjamin C. Pierce
  International Workshop on Foundations and Developments of Object-Oriented Languages (FOOL/WOOD),
  January 2007

  https://www.microsoft.com/en-us/research/publication/on-decidability-of-nominal-subtyping-with-variance/

*)

let debug = false (* set to 1 to show graph in error message *)

(* Collecting type constructors *)

module Vertex = struct
  type t = Type.con * int
  let compare (c,i) (d,j) =
  <span data-count="177834">m</span>atch Cons.compare c d with
  | <span data-count="56926">0</span> -&gt; compare i j
  | <span data-count="120908">n</span> -&gt; n
end

module Edge = struct
  type t = Vertex.t * int * Vertex.t
  let compare (c1, w1, d1) (c2, w2, d2) =
  <span data-count="946">m</span>atch Vertex.compare c1 c2 with
  | <span data-count="140">0</span> -&gt;
    begin
      match compare w1 w2 with
      | <span data-count="102">0</span> -&gt; Vertex.compare d1 d2
      | <span data-count="38">n</span> -&gt; n
    end
  | <span data-count="806">n</span> -&gt; n
end

module VertexSet = Set.Make(Vertex)

module EdgeSet = Set.Make(Edge)

let string_of_vertex (c, i) = <span data-count="0">P</span>rintf.sprintf "(%s,%i)" (Cons.nam<span data-count="0">e</span> c) i

let string_of_vertices vs =
  <span data-count="0">P</span>rintf.sprintf "{ %s }" (String.conca<span data-count="0">t</span> "," (List.ma<span data-count="0">p</span> string_of_vertex (VertexSet.element<span data-count="0">s</span> vs)))

let string_of_edge (ci,w,dj) =
  <span data-count="0">P</span>rintf.sprintf ("%s -%i-&gt; %s") (string_of_verte<span data-count="0">x</span> ci) w (string_of_verte<span data-count="0">x</span> dj)

let string_of_edges es =
  <span data-count="0">P</span>rintf.sprintf "{ %s }" (String.conca<span data-count="0">t</span> "," (List.ma<span data-count="0">p</span> string_of_edge (EdgeSet.element<span data-count="0">s</span> es)))

let edges_typ cs c (es : EdgeSet.t) t : EdgeSet.t =
  <span data-count="107577">l</span>et rec go_typs i exp non es ts =
    <span data-count="95771">L</span>ist.fold_left (go_ty<span data-count="95771">p</span> i exp non) es ts
  and go_typ i exp non es = function
    | <span data-count="11890">V</span>ar (s, j) when j &gt;= i  -&gt;
      <span data-count="9923">l</span>et ci = (c, j - i) in
      let es1 = VertexSet.fold (fun dj es -&gt; <span data-count="53">E</span>dgeSet.add (ci, 1, dj) es) exp es in
      <span data-count="9923">l</span>et es2 = VertexSet.fold (fun dj es -&gt; <span data-count="2216">E</span>dgeSet.add (ci, 0, dj) es) non es1 in
      <span data-count="9923">e</span>s2
    | <span data-count="1967">V</span>ar (s, j) -&gt;
      assert <span data-count="1967">(</span>j &lt; i);
      es
    | (<span data-count="64841">P</span>rim _ | <span data-count="15035">A</span>ny | <span data-count="3410">N</span>on | <span data-count="0">P</span>re ) -&gt; es
    | <span data-count="48034">C</span>on (d, ts) when ConSet.me<span data-count="48034">m</span> d cs -&gt;
      <span data-count="12092">l</span>et exp1 = VertexSet.union exp non in
      <span data-count="12092">l</span>et _, es = List.fold_left
        (fun (k, es) t -&gt;
          <span data-count="4116">(</span>k + 1,
           go_ty<span data-count="4116">p</span> i exp1 (VertexSet.singleto<span data-count="4116">n</span> (d, k)) es t))
        (0, es)
        ts
      in
      <span data-count="12092">e</span>s
    | <span data-count="35942">C</span>on (_, ts) (* Cons from outer scopes are assumed to be non-expansive *)
    | <span data-count="10184">T</span>up ts -&gt;
      go_typs i (VertexSet.unio<span data-count="46126">n</span> exp non) VertexSet.empty es ts
    | (<span data-count="21609">O</span>pt t1 | <span data-count="1850">M</span>ut t1 | <span data-count="5419">A</span>rray t1) -&gt;
      go_typ i (VertexSet.unio<span data-count="28878">n</span> exp non) VertexSet.empty es t1
    | <span data-count="1772">A</span>sync (s, t1, t2) -&gt;
      go_typs i (VertexSet.unio<span data-count="1772">n</span> exp non) VertexSet.empty es [t1;t2]
    | <span data-count="11421">F</span>unc (s, _c, tbs, ts1, ts2) -&gt;
      let i1 = i + List.lengt<span data-count="11421">h</span> tbs in
      let exp1 = VertexSet.union exp non in
      <span data-count="11421">l</span>et es1 = go_typs i1 exp1 VertexSet.empty es
        (List.ma<span data-count="11421">p</span> (fun tb -&gt; <span data-count="2236">t</span>b.bound) tbs)
      in
      <span data-count="11421">l</span>et es2 = go_typs i1 exp1 VertexSet.empty es1 ts1
      in
      <span data-count="11421">g</span>o_typs i1 exp1 VertexSet.empty es2 ts2
    | (<span data-count="9015">O</span>bj (_, fs) | <span data-count="4595">V</span>ariant fs) -&gt;
      go_typs i (VertexSet.unio<span data-count="13610">n</span> exp non) VertexSet.empty es
        (List.ma<span data-count="13610">p</span> (fun f -&gt; <span data-count="42833">f</span>.typ) fs)
    | <span data-count="63">T</span>yp c -&gt;
      (* Since constructors must be closed, no further edges possible *)
      es
  in
  go_typ 0 VertexSet.empty VertexSet.empty es t

let edges_con cs c es : EdgeSet.t =
  <span data-count="98052">m</span>atch Cons.kind c with
  | <span data-count="98052">D</span>ef (tbs, t) -&gt;
    (* It's not clear we actually need to consider parameters bounds, since, unlike
       function type parameters, they don't introduce new subgoals during subtyping.
       But let's be conservative and consider them, until we find out that that's undesirable
       and know its safe to ignore them here. *)
    let es1 = List.fold_left (fun es tb -&gt;
      <span data-count="9525">e</span>dges_typ cs c es tb.bound) es tbs
    in
    <span data-count="98052">e</span>dges_typ cs c es1 t
  | Abs (tbs, t) -&gt;
    assert false

let edges cs = <span data-count="244433">C</span>onSet.fold (edges_co<span data-count="244433">n</span> cs) cs EdgeSet.empty

let vertices cs =
  <span data-count="244433">C</span>onSet.fold
    (fun c vs -&gt;
      <span data-count="98052">m</span>atch Cons.kind c with
      | <span data-count="98052">D</span>ef (tbs, t) -&gt;
        let ws = List.mapi (fun i _tb -&gt; <span data-count="9525">(</span>c, i)) tbs in
        <span data-count="98052">L</span>ist.fold_left (fun vs v -&gt; <span data-count="9525">V</span>ertexSet.add v vs) vs ws
      | Abs (tbs, t) -&gt;
        assert false) cs VertexSet.empty

module VertexMap = Map.Make(Vertex)

module Scc = Scc.Make(Vertex)

let string_of_sccs sccs =
  <span data-count="0">P</span>rintf.sprintf "{ %s }" (String.conca<span data-count="0">t</span> ","
   (List.ma<span data-count="0">p</span> string_of_vertices sccs))

module Pretty = MakePretty(ElideStamps)

let is_expansive cs =
  (* Collect vertices and labeled edges *)
  <span data-count="244433">l</span>et vs = vertices cs in
  <span data-count="244433">l</span>et es = edges cs in
  (* Compute the strongly connected components (ignoring edge labels) *)
  <span data-count="244433">l</span>et unlabeled_es = EdgeSet.fold
    (fun (ci, w, dj) -&gt; <span data-count="2192">S</span>cc.EdgeSet.add (ci, dj)) es Scc.EdgeSet.empty
  in
  <span data-count="244433">l</span>et vss = Scc.scc vs unlabeled_es in

  (* Map each vertex to the number of its component *)
  <span data-count="244433">l</span>et component = List.fold_left (fun m (vs, i) -&gt;
    <span data-count="9475">V</span>ertexSet.fold (fun v m -&gt; <span data-count="9525">V</span>ertexMap.add v i m) vs m)
    VertexMap.empty (List.map<span data-count="244433">i</span> (fun i vs -&gt; <span data-count="9475">(</span>vs, i)) vss)
  in

  (* The constructor are expansive if some component (cycle) contains
     an edge with non-zero weight *)
  <span data-count="244433">l</span>et e_opt = List.find_opt
    (fun (ci, w, dj) -&gt;
      <span data-count="2191">w</span> &gt; 0 &amp;&amp; <span data-count="51">V</span>ertexMap.fin<span data-count="51">d</span> ci component = VertexMap.fin<span data-count="51">d</span> dj component)
    (EdgeSet.element<span data-count="244433">s</span> es)
  in
  <span data-count="244433">m</span>atch e_opt with
  | <span data-count="244420">N</span>one -&gt; None
  | <span data-count="13">S</span>ome ((c,i), _, (d,j)) -&gt;
    (* Construct an error messages with optional debug info *)
    let op, sbs, st = Pretty.strings_of_kind (Cons.kin<span data-count="13">d</span> c) in
    <span data-count="13">l</span>et def = Printf.sprintf "type %s%s %s %s" (Cons.nam<span data-count="13">e</span> c) sbs op st in
    <span data-count="13">l</span>et x = match Cons.kind c with <span data-count="13">D</span>ef(tbs, _) | <span data-count="0">A</span>bs(tbs, _) -&gt;
      (List.nt<span data-count="13">h</span> tbs i).var in
    let dys = match Cons.kind d with <span data-count="13">D</span>ef(tbs, _) | <span data-count="0">A</span>bs(tbs, _) -&gt;
      Printf.sprint<span data-count="13">f</span> "%s&lt;%s&gt;" (Cons.nam<span data-count="13">e</span> d)
        (String.conca<span data-count="13">t</span> "," (List.map<span data-count="13">i</span> (fun k _ -&gt;
          <span data-count="19">i</span>f i = k then <span data-count="13">"</span>-" ^ x ^"-" else <span data-count="6">"</span>_") tbs))
    in
    Some (Printf.sprint<span data-count="13">f</span>
      ":\n  %s\nis expansive, because %s occurs as an indirect argument of recursive type %s.\n(%s would be allowed as an immediate argument, but cannot be part of a larger type expression.)%s"
      def x dys x
      (if debug then
         <span data-count="0">P</span>rintf.sprint<span data-count="0">f</span>
           "\n  vertices:\n    %s\n  edges:\n    %s\n  components:\n    %s"
           (string_of_vertice<span data-count="0">s</span> vs) (string_of_edge<span data-count="0">s</span> es) (string_of_scc<span data-count="0">s</span> vss)
       else <span data-count="13">"</span>"))
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
