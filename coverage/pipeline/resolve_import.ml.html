<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>resolve_import.ml &mdash; Coverage report</title>
    <meta name="description" content="93.18% coverage in pipeline/resolve_import.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">pipeline/</span>resolve_import.ml
        </a>
      </h1>
      <h2>93.18%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:46.15%"></span>
      <span class="unvisited" style="top:48.60%"></span>
      <span class="unvisited" style="bottom:48.60%"></span>
      <span class="unvisited" style="bottom:26.22%"></span>
      <span class="some-visited" style="bottom:5.59%"></span>
      <span class="unvisited" style="bottom:2.45%"></span>
      <span class="unvisited" style="bottom:1.75%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span class="visited"> </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span class="visited"> </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span class="visited"> </span>
<a id="L68"></a><span > </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span class="visited"> </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span class="visited"> </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span > </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span > </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span class="visited"> </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span class="unvisited"> </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span class="visited"> </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span class="unvisited"> </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span class="visited"> </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span class="unvisited"> </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span class="visited"> </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span class="visited"> </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span class="visited"> </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span class="visited"> </span>
<a id="L169"></a><span class="visited"> </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span class="visited"> </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span > </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span class="visited"> </span>
<a id="L185"></a><span class="visited"> </span>
<a id="L186"></a><span > </span>
<a id="L187"></a><span class="visited"> </span>
<a id="L188"></a><span class="visited"> </span>
<a id="L189"></a><span > </span>
<a id="L190"></a><span class="visited"> </span>
<a id="L191"></a><span class="visited"> </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span > </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span > </span>
<a id="L198"></a><span > </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span > </span>
<a id="L206"></a><span > </span>
<a id="L207"></a><span > </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span class="visited"> </span>
<a id="L211"></a><span class="unvisited"> </span>
<a id="L212"></a><span class="visited"> </span>
<a id="L213"></a><span class="visited"> </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span > </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span class="visited"> </span>
<a id="L218"></a><span class="visited"> </span>
<a id="L219"></a><span class="visited"> </span>
<a id="L220"></a><span class="visited"> </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span > </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span > </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span > </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span > </span>
<a id="L231"></a><span class="visited"> </span>
<a id="L232"></a><span > </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span > </span>
<a id="L236"></a><span > </span>
<a id="L237"></a><span > </span>
<a id="L238"></a><span > </span>
<a id="L239"></a><span > </span>
<a id="L240"></a><span > </span>
<a id="L241"></a><span > </span>
<a id="L242"></a><span > </span>
<a id="L243"></a><span > </span>
<a id="L244"></a><span > </span>
<a id="L245"></a><span > </span>
<a id="L246"></a><span > </span>
<a id="L247"></a><span > </span>
<a id="L248"></a><span > </span>
<a id="L249"></a><span > </span>
<a id="L250"></a><span class="visited"> </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span class="visited"> </span>
<a id="L253"></a><span class="visited"> </span>
<a id="L254"></a><span > </span>
<a id="L255"></a><span > </span>
<a id="L256"></a><span > </span>
<a id="L257"></a><span > </span>
<a id="L258"></a><span class="visited"> </span>
<a id="L259"></a><span class="visited"> </span>
<a id="L260"></a><span class="visited"> </span>
<a id="L261"></a><span class="visited"> </span>
<a id="L262"></a><span > </span>
<a id="L263"></a><span class="visited"> </span>
<a id="L264"></a><span class="visited"> </span>
<a id="L265"></a><span > </span>
<a id="L266"></a><span > </span>
<a id="L267"></a><span > </span>
<a id="L268"></a><span > </span>
<a id="L269"></a><span > </span>
<a id="L270"></a><span class="some-visited"> </span>
<a id="L271"></a><span > </span>
<a id="L272"></a><span class="visited"> </span>
<a id="L273"></a><span > </span>
<a id="L274"></a><span class="visited"> </span>
<a id="L275"></a><span class="visited"> </span>
<a id="L276"></a><span class="visited"> </span>
<a id="L277"></a><span class="visited"> </span>
<a id="L278"></a><span > </span>
<a id="L279"></a><span class="unvisited"> </span>
<a id="L280"></a><span > </span>
<a id="L281"></a><span class="unvisited"> </span>
<a id="L282"></a><span > </span>
<a id="L283"></a><span class="visited"> </span>
<a id="L284"></a><span class="visited"> </span>
<a id="L285"></a><span class="visited"> </span>
<a id="L286"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
<a href="#L277">277</a>
<a href="#L278">278</a>
<a href="#L279">279</a>
<a href="#L280">280</a>
<a href="#L281">281</a>
<a href="#L282">282</a>
<a href="#L283">283</a>
<a href="#L284">284</a>
<a href="#L285">285</a>
<a href="#L286">286</a>
</pre>
<pre><code class="ocaml">open Mo_def
open Ic
module Traversals = Mo_frontend.Traversals

(*
This module traverses the syntax tree. For each `import` statement, it looks
at the given relative path and tries to resolve it to a full path (where
full means relative to the current working directory, so that source
directories do not creep into the build output). If no file can be found
there, this prints an error message, otherwise it stores the real path
in the second, mutable field of the ImportE statement.

It returns a list of all imported file names.

*)

type filepath = string
type url = string
type blob = string

type resolved_imports = Syntax.resolved_import Source.phrase list

(* This returns a map from Syntax.resolved_import
   to the location of the first import of that library
*)
module RIM = Map.Make
  (struct
    type t = Syntax.resolved_import
    let compare = compare
  end)

(* The Set variant is used in the pipeline module *)
module S = Set.Make
  (struct
    type t = Syntax.resolved_import
    let compare = compare
  end)


(* a map of type package_map will map each package name to local, non-relative
   filepath e.g.,
   packages("std") = "/Users/home/username/.dfinity-sdk/src/mo-stdlib/0.1.0/"
   packages("foo") = "/Users/home/username/fooPackage/1.2.3/src"
*)
module M = Map.Make(String)
type package_map = filepath M.t

open Syntax
open Source

let err_unrecognized_url msgs at url msg =
  <span data-count="2">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="2">e</span>
       at
       "M0006"
       "import"
       (Printf.sprint<span data-count="2">f</span> "cannot parse import URL \"%s\": %s" url msg))

let err_unrecognized_alias msgs alias principal msg =
  <span data-count="3">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="3">e</span>
       no_region
       "M0007"
       "actor-alias"
       (Printf.sprint<span data-count="3">f</span> "cannot parse principal \"%s\" for actor alias \"%s\": %s" principal alias msg))

let err_actor_import_without_idl_path msgs at =
  <span data-count="1">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="1">e</span>
       at
       "M0008"
       "import"
      (Printf.sprint<span data-count="1">f</span> "cannot import canister urls without --actor-idl param"))

let err_file_does_not_exist' at full_path =
  <span data-count="1">D</span>iag.error_message
    at
    "M0009"
    "import"
    (Printf.sprint<span data-count="1">f</span> "file \"%s\" does not exist" full_path)

let err_file_does_not_exist msgs at full_path =
  <span data-count="1">D</span>iag.add_msg msgs (err_file_does_not_exist<span data-count="1">'</span> at full_path)

let err_package_not_defined msgs at pkg =
  <span data-count="1">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="1">e</span>
       at
       "M0010"
       "import"
       (Printf.sprint<span data-count="1">f</span> "package \"%s\" not defined" pkg))

let err_alias_not_defined msgs at alias =
  <span data-count="1">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="1">e</span>
       at
       "M0011"
       "import"
       (Printf.sprint<span data-count="1">f</span> "canister alias \"%s\" not defined" alias))

let err_package_file_does_not_exist msgs f pname =
  <span data-count="1">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="1">e</span>
       no_region
       "M0012"
       "package"
       (Printf.sprint<span data-count="1">f</span> "file \"%s\" (for package `%s`) does not exist" f pname))

let err_prim_pkg msgs =
  <span data-count="1">l</span>et open Diag in
  add_msg msgs
    (error_messag<span data-count="1">e</span>
       no_region
       "M0013"
       "package" "the \"prim\" package is built-in, and cannot be mapped to a directory")

let append_extension : (string -&gt; bool) -&gt; string -&gt; string =
  fun file_exists f -&gt;
  <span data-count="815">l</span>et file_path = f ^ ".mo" in
  let lib_path = Filename.concat f "lib.mo" in
  <span data-count="815">i</span>f Option.is_some (Lib.String.chop_suffi<span data-count="815">x</span> "/" f) then
    <span data-count="6">l</span>ib_path
  else <span data-count="809">i</span>f file_exists file_path then
    <span data-count="809">f</span>ile_path
  else
    <span data-count="0">l</span>ib_path

let resolve_lib_import at full_path : (string, Diag.message) result =
  <span data-count="815">l</span>et full_path = append_extension Sys.file_exists full_path in
  <span data-count="815">l</span>et full_path = Lib.FilePath.normalise full_path in
  <span data-count="815">i</span>f Sys.file_exists full_path
  then <span data-count="815">O</span>k full_path
  else <span data-count="0">E</span>rror (err_file_does_not_exist<span data-count="0">'</span> at full_path)

let add_lib_import msgs imported ri_ref at full_path =
  <span data-count="813">m</span>atch resolve_lib_import at full_path with
  | <span data-count="813">O</span>k full_path -&gt; begin
      ri_ref := LibPath full_path;
      imported := RIM.ad<span data-count="813">d</span> (LibPath full_path) at !imported
    end
  | <span data-count="0">E</span>rror err -&gt;
     Diag.add_msg msgs err

let add_idl_import msgs imported ri_ref at full_path bytes =
  <span data-count="30">i</span>f Sys.file_exists full_path
  then <span data-count="29">b</span>egin
    ri_ref := IDLPath (full_path, bytes);
    imported := RIM.ad<span data-count="29">d</span> (IDLPath (full_path, bytes)) at !imported
  end else
    <span data-count="1">e</span>rr_file_does_not_exist msgs at full_path

let add_prim_import imported ri_ref at =
  <span data-count="1121">r</span>i_ref := PrimPath;
  imported := RIM.ad<span data-count="1121">d</span> PrimPath at !imported

let in_base base f =
  <span data-count="845">i</span>f base = "."
  then <span data-count="343">f</span>
  else <span data-count="502">F</span>ilename.concat base f

let resolve_import_string msgs base actor_idl_path aliases packages imported (f, ri_ref, at)  =
  <span data-count="1969">l</span>et resolve_ic bytes = <span data-count="31">m</span>atch actor_idl_path with
    | <span data-count="1">N</span>one -&gt; err_actor_import_without_idl_path msgs at
    | <span data-count="30">S</span>ome actor_base -&gt;
      let full_path = in_base actor_base (Url.idl_basename_of_blo<span data-count="30">b</span> bytes) in
      <span data-count="30">a</span>dd_idl_import msgs imported ri_ref at full_path bytes
  in
  match Url.parse f with
  | <span data-count="805">O</span>k (Url.Relative path) -&gt;
    (* TODO support importing local .did file *)
    add_lib_import msgs imported ri_ref at (in_bas<span data-count="805">e</span> base path)
  | <span data-count="9">O</span>k (Url.Package (pkg,path)) -&gt;
    begin match M.find_opt pkg packages with
    | <span data-count="8">S</span>ome pkg_path -&gt; add_lib_import msgs imported ri_ref at (in_bas<span data-count="8">e</span> pkg_path path)
    | <span data-count="1">N</span>one -&gt; err_package_not_defined msgs at pkg
    end
  | <span data-count="21">O</span>k (Url.Ic bytes) -&gt;
     if String.lengt<span data-count="21">h</span> bytes &gt; 29 then
       <span data-count="1">e</span>rr_unrecognized_url msgs at f "Principal too long"
     else
     <span data-count="20">r</span>esolve_ic bytes
  | <span data-count="12">O</span>k (Url.IcAlias alias) -&gt;
    begin match M.find_opt alias aliases with
    | <span data-count="11">S</span>ome bytes -&gt; resolve_ic bytes
    | <span data-count="1">N</span>one -&gt; err_alias_not_defined msgs at alias
    end
  | <span data-count="1121">O</span>k Url.Prim -&gt;
    add_prim_import imported ri_ref at
  | <span data-count="1">E</span>rror msg -&gt;
    err_unrecognized_url msgs at f msg

(* Resolve the argument to --package. *)
let resolve_package_url (msgs:Diag.msg_store) (pname:string) (f:url) : filepath =
  <span data-count="14">i</span>f pname = "prim" then <span data-count="1">(</span>err_prim_pkg msgs ;<span data-count="1">"</span>") else
  <span data-count="13">l</span>et f = Lib.FilePath.normalise f in
  <span data-count="13">i</span>f Sys.file_exists f
  then <span data-count="12">f</span>
  else <span data-count="1">(</span>err_package_file_does_not_exist msgs f pname;<span data-count="1">"</span>")

(* Resolve the argument to --actor-alias. Check eagerly for well-formedness *)
let resolve_alias_principal (msgs:Diag.msg_store) (alias:string) (f:string) : blob =
  <span data-count="15">m</span>atch Url.decode_principal f with
  | <span data-count="12">O</span>k bytes -&gt;
     if String.lengt<span data-count="12">h</span> bytes &gt; 29 then
       <span data-count="0">(</span>err_unrecognized_alias msgs alias f "Principal too long"; <span data-count="0">"</span>")
     else <span data-count="12">b</span>ytes
  | <span data-count="3">E</span>rror msg -&gt; err_unrecognized_alias msgs alias f msg; <span data-count="3">"</span>"


let prog_imports (p : prog): (url * resolved_import ref * region) list =
  <span data-count="2347">l</span>et res = ref [] in
  let f e = <span data-count="218094">m</span>atch e.it with
    | <span data-count="1973">I</span>mportE (f, fp) -&gt; res := (f, fp, e.at) ::!res; e
    | <span data-count="216121">_</span> -&gt; e in
  let _ = ignore (Traversals.over_pro<span data-count="2347">g</span> f p) in
  List.rev !res

type actor_idl_path = filepath option
type package_urls = url M.t
type actor_aliases = url M.t
type aliases = blob M.t


let resolve_packages : package_urls -&gt; package_map Diag.result = fun purls -&gt;
  <span data-count="2348">D</span>iag.with_message_store (fun msgs -&gt; <span data-count="2348">S</span>ome (M.map<span data-count="2348">i</span> (resolve_package_ur<span data-count="2348">l</span> msgs) purls))

let resolve_aliases : actor_aliases -&gt; aliases Diag.result = fun alias_principals -&gt;
  <span data-count="2346">D</span>iag.with_message_store (fun msgs -&gt; <span data-count="2346">S</span>ome (M.map<span data-count="2346">i</span> (resolve_alias_principa<span data-count="2346">l</span> msgs) alias_principals))

type flags = {
  package_urls : package_urls;
  actor_aliases : actor_aliases;
  actor_idl_path : actor_idl_path;
  }

type resolved_flags = {
  packages : package_map;
  aliases : aliases;
  actor_idl_path : actor_idl_path;
  }

let resolve_flags : flags -&gt; resolved_flags Diag.result
  = fun { actor_idl_path; package_urls; actor_aliases } -&gt;
  <span data-count="2348">l</span>et open Diag.Syntax in
  let* packages = resolve_package<span data-count="2348">s</span> package_urls in
  <span data-count="2346">l</span>et* aliases = resolve_aliase<span data-count="2346">s</span> actor_aliases in
  <span data-count="2345">D</span>iag.return { packages; aliases; actor_idl_path }

let resolve
  : flags -&gt; Syntax.prog -&gt; filepath -&gt; resolved_imports Diag.result
  = fun flags p base -&gt;
  <span data-count="2348">l</span>et open Diag.Syntax in
  let* { packages; aliases; actor_idl_path } = resolve_flag<span data-count="2348">s</span> flags in
  <span data-count="2345">D</span>iag.with_message_store (fun msgs -&gt;
    <span data-count="2345">l</span>et base = if Sys.is_directory base then <span data-count="150">b</span>ase else <span data-count="2195">F</span>ilename.dirnam<span data-count="2195">e</span> base in
    let imported = ref RIM.empty in
    List.iter (resolve_import_strin<span data-count="2345">g</span> msgs base actor_idl_path aliases packages imported) (prog_import<span data-count="2345">s</span> p);
    <span data-count="2345">S</span>ome (List.ma<span data-count="2345">p</span> (fun (rim,at) -&gt; <span data-count="1945">r</span>im @@ at) (RIM.binding<span data-count="2345">s</span> !imported))
  )


let collect_imports (p:prog) base : ((url * url option) list) Diag.result =
  (* TODO unify the code path for resolve and collect_imports *)
  <span data-count="2">l</span>et base = if Sys.is_directory base then <span data-count="0">b</span>ase else <span data-count="2">F</span>ilename.dirnam<span data-count="2">e</span> base in
  Diag.with_message_store (fun msgs -&gt;
      <span data-count="2">l</span>et imports =
        List.map (fun (f, _, at) -&gt;
            <span data-count="4">m</span>atch Url.parse f with
            | <span data-count="2">O</span>k (Url.Relative path) -&gt; begin
               match resolve_lib_import at (in_bas<span data-count="2">e</span> base path) with
               | <span data-count="2">O</span>k full_path -&gt;
                  (f, Some full_path)
               | <span data-count="0">E</span>rror err -&gt;
                  Diag.add_msg msgs err;
                  <span data-count="0">(</span>f, None)
              end
            | <span data-count="2">_</span> -&gt; (f, None)
          ) (prog_import<span data-count="2">s</span> p) in
       <span data-count="2">S</span>ome imports
    )
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
